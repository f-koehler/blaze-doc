<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Custom Operations</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../Blaze.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blaze.jpg"/></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Custom Operations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In addition to the provided operations on vectors and matrices it is possible to define custom operations. For this purpose, <b>Blaze</b> provides the <code><a class="el" href="../../db/df0/group__dense__matrix.html#gacbb0c018752c3e955e7ffbee96c415eb" title="Evaluates the given custom operation on each single element of the dense matrix dm. ">forEach()</a></code> function, which allows to pass the required operation via functor or lambda:</p>
<div class="fragment"><div class="line"><a class="code" href="../../de/d1e/classblaze_1_1DynamicMatrix.html">blaze::DynamicMatrix&lt;double&gt;</a> A, B;</div><div class="line"></div><div class="line">B = <a class="code" href="../../db/df0/group__dense__matrix.html#gacbb0c018752c3e955e7ffbee96c415eb">forEach</a>( A, []( <span class="keywordtype">double</span> d ){ <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">std::sqrt</a>( d ); } );</div></div><!-- fragment --><p>This example demonstrates the most convenient way of defining a custom operation by passing a lambda to the <code><a class="el" href="../../db/df0/group__dense__matrix.html#gacbb0c018752c3e955e7ffbee96c415eb" title="Evaluates the given custom operation on each single element of the dense matrix dm. ">forEach()</a></code> function. The lambda is executed on each single element of a dense vector or matrix or each non-zero element of a sparse vector or matrix.</p>
<p>Alternatively, it is possible to pass a custom functor:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>Sqrt</div><div class="line">{</div><div class="line">   <span class="keywordtype">double</span> operator()( <span class="keywordtype">double</span> a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">std::sqrt</a>( a );</div><div class="line">   }</div><div class="line">};</div><div class="line"></div><div class="line">B = <a class="code" href="../../db/df0/group__dense__matrix.html#gacbb0c018752c3e955e7ffbee96c415eb">forEach</a>( A, Sqrt() );</div></div><!-- fragment --><p>In order for the functor to work in a call to <code><a class="el" href="../../db/df0/group__dense__matrix.html#gacbb0c018752c3e955e7ffbee96c415eb" title="Evaluates the given custom operation on each single element of the dense matrix dm. ">forEach()</a></code> it must define a function call operator, which accepts arguments of the type of the according vector or matrix elements.</p>
<p>Although the operation is automatically parallelized depending on the size of the vector or matrix, no automatic vectorization is possible. In order to enable vectorization, a <code>load()</code> function can be added to the functor, which handles the vectorized computation. Depending on the data type this function is passed one of the following <b>Blaze</b> SIMD data types:</p>
<ul>
<li>
SIMD data types for fundamental data types <ul>
<li>
<code><a class="el" href="../../d0/df2/classblaze_1_1SIMDint8.html" title="SIMD type for 8-bit signed integral data values. ">blaze::SIMDint8</a>:</code> Packed SIMD type for 8-bit signed integral data types </li>
<li>
<code><a class="el" href="../../dd/d00/classblaze_1_1SIMDuint8.html" title="SIMD type for 8-bit unsigned integral data values. ">blaze::SIMDuint8</a>:</code> Packed SIMD type for 8-bit unsigned integral data types </li>
<li>
<code><a class="el" href="../../d5/d4c/classblaze_1_1SIMDint16.html" title="SIMD type for 16-bit signed integral data values. ">blaze::SIMDint16</a>:</code> Packed SIMD type for 16-bit signed integral data types </li>
<li>
<code><a class="el" href="../../d5/d05/classblaze_1_1SIMDuint16.html" title="SIMD type for 16-bit unsigned integral data values. ">blaze::SIMDuint16</a>:</code> Packed SIMD type for 16-bit unsigned integral data types </li>
<li>
<code><a class="el" href="../../db/dca/classblaze_1_1SIMDint32.html" title="SIMD type for 32-bit signed integral data values. ">blaze::SIMDint32</a>:</code> Packed SIMD type for 32-bit signed integral data types </li>
<li>
<code><a class="el" href="../../d8/d06/classblaze_1_1SIMDuint32.html" title="SIMD type for 32-bit unsigned integral data values. ">blaze::SIMDuint32</a>:</code> Packed SIMD type for 32-bit unsigned integral data types </li>
<li>
<code><a class="el" href="../../d0/d16/classblaze_1_1SIMDint64.html" title="SIMD type for 64-bit integral data values. ">blaze::SIMDint64</a>:</code> Packed SIMD type for 64-bit signed integral data types </li>
<li>
<code><a class="el" href="../../d1/d32/classblaze_1_1SIMDuint64.html" title="SIMD type for 64-bit unsigned integral data values. ">blaze::SIMDuint64</a>:</code> Packed SIMD type for 64-bit unsigned integral data types </li>
<li>
<code><a class="el" href="../../d2/dba/classblaze_1_1SIMDfloat.html" title="SIMD type for 32-bit single precision floating point data values. ">blaze::SIMDfloat</a>:</code> Packed SIMD type for single precision floating point data </li>
<li>
<code><a class="el" href="../../d2/d94/classblaze_1_1SIMDdouble.html" title="SIMD type for 64-bit double precision floating point data values. ">blaze::SIMDdouble</a>:</code> Packed SIMD type for double precision floating point data </li>
</ul>
</li>
<li>
SIMD data types for complex data types <ul>
<li>
<code>blaze::cint8:</code> Packed SIMD type for complex 8-bit signed integral data types </li>
<li>
<code>blaze::cuint8:</code> Packed SIMD type for complex 8-bit unsigned integral data types </li>
<li>
<code>blaze::cint16:</code> Packed SIMD type for complex 16-bit signed integral data types </li>
<li>
<code>blaze::cuint16:</code> Packed SIMD type for complex 16-bit unsigned integral data types </li>
<li>
<code>blaze::cint32:</code> Packed SIMD type for complex 32-bit signed integral data types </li>
<li>
<code>blaze::cuint32:</code> Packed SIMD type for complex 32-bit unsigned integral data types </li>
<li>
<code>blaze::cint64:</code> Packed SIMD type for complex 64-bit signed integral data types </li>
<li>
<code>blaze::cuint64:</code> Packed SIMD type for complex 64-bit unsigned integral data types </li>
<li>
<code>blaze::cfloat:</code> Packed SIMD type for complex single precision floating point data </li>
<li>
<code>blaze::cdouble:</code> Packed SIMD type for complex double precision floating point data </li>
</ul>
</li>
</ul>
<p>All SIMD types provide the <code>value</code> data member for a direct access to the underlying intrinsic data element. In the following example, this intrinsic element is passed to the AVX function <code>_mm256_sqrt_pd()</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>Sqrt</div><div class="line">{</div><div class="line">   <span class="keywordtype">double</span> operator()( <span class="keywordtype">double</span> a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">std::sqrt</a>( a );</div><div class="line">   }</div><div class="line"></div><div class="line">   simd_double_t load( simd_double_t a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="keywordflow">return</span> _mm256_sqrt_pd( a.value );</div><div class="line">   }</div><div class="line">};</div></div><!-- fragment --><p>In this example, whenever vectorization is generally applicable, the <code>load()</code> function is called instead of the function call operator for as long as the number of remaining elements is larger-or-equal to the width of the packed SIMD type. In all other cases (which also includes peel-off and remainder loops) the scalar operation is used.</p>
<p>Please note that this example has two drawbacks: First, it will only compile in case the intrinsic <code>_mm256_sqrt_pd()</code> function is available (i.e. when AVX is active). Second, the availability of AVX is not taken into account. The first drawback can be alleviated by making the <code>load()</code> function a function template. The second drawback can be dealt with by adding a <code>simdEnabled()</code> function template to the functor:</p>
<div class="fragment"><div class="line">   <span class="keyword">struct </span>Sqrt</div><div class="line">   {</div><div class="line">      <span class="keywordtype">double</span> operator()( <span class="keywordtype">double</span> a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">      </span>{</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">std::sqrt</a>( a );</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">template</span>&lt; <span class="keyword">typename</span> T &gt;</div><div class="line">      T load( T a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">      </span>{</div><div class="line">         <span class="keywordflow">return</span> _mm256_sqrt_pd( a.value );</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">template</span>&lt; <span class="keyword">typename</span> T &gt;</div><div class="line">      <span class="keyword">static</span> constexpr <span class="keywordtype">bool</span> simdEnabled() {</div><div class="line"><span class="preprocessor">#if defined(__AVX__)</span></div><div class="line">         <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">         <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line">   };</div></div><!-- fragment --><p>The <code>simdEnabled()</code> function must be a <code>static</code>, <code>constexpr</code> function and must return whether or not vectorization is available for the given data type <code>T</code>. In case the function returns <code>true</code>, the <code>load()</code> function is used for a vectorized evaluation, in case the function returns <code>false</code>, <code>load()</code> is not called.</p>
<p>Note that this is a simplified example that is only working when used for dense vectors and matrices with double precision floating point elements. The following code shows the complete implementation of the according functor that is used within the <b>Blaze</b> library. The <b>Blaze</b> <code>Sqrt</code> functor is working for all data types that are providing a square root operation:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="../../d2/de9/namespaceblaze.html">blaze</a> {</div><div class="line"></div><div class="line"><span class="keyword">struct </span>Sqrt</div><div class="line">{</div><div class="line">   <span class="keyword">template</span>&lt; <span class="keyword">typename</span> T &gt;</div><div class="line">   <a class="code" href="../../d4/d37/group__system.html#ga414fb20bc543f1b920b6599c9b63a23a">BLAZE_ALWAYS_INLINE</a> <span class="keyword">auto</span> <a class="code" href="../../d0/d06/structblaze_1_1Sqrt.html#a8b1d5b2e46eabe125916304c9ae70700">operator()</a>( <span class="keyword">const</span> T&amp; a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">sqrt</a>( a );</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keyword">template</span>&lt; <span class="keyword">typename</span> T &gt;</div><div class="line">   <span class="keyword">static</span> constexpr <span class="keywordtype">bool</span> <a class="code" href="../../d0/d06/structblaze_1_1Sqrt.html#ad87efbea4dc8693ff8d231c85d7208db">simdEnabled</a>() { <span class="keywordflow">return</span> HasSIMDSqrt&lt;T&gt;::value; }</div><div class="line"></div><div class="line">   <span class="keyword">template</span>&lt; <span class="keyword">typename</span> T &gt;</div><div class="line">   <a class="code" href="../../d4/d37/group__system.html#ga414fb20bc543f1b920b6599c9b63a23a">BLAZE_ALWAYS_INLINE</a> <span class="keyword">auto</span> <a class="code" href="../../d0/d06/structblaze_1_1Sqrt.html#a899c8d63c0927532d1dd8ab01e45b151">load</a>( <span class="keyword">const</span> T&amp; a )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      BLAZE_CONSTRAINT_MUST_BE_SIMD_TYPE( T );</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="../../db/df0/group__dense__matrix.html#ga660a4e2de4b63aac4181af49ac9160d8">sqrt</a>( a );</div><div class="line">   }</div><div class="line">};</div><div class="line"></div><div class="line">} <span class="comment">// namespace blaze</span></div></div><!-- fragment --><p>For more information on the available <b>Blaze</b> SIMD data types and functions, please see the SIMD module in the complete <b>Blaze</b> documentation.</p>
<p><br />
 Previous: <a class="el" href="../../d1/df6/matrix_matrix_multiplication.html">Matrix/Matrix Multiplication</a> &#160; &#160; Next: <a class="el" href="../../df/d92/shared_memory_parallelization.html">Shared Memory Parallelization</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Oct 8 2016 16:45:02 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
